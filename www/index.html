<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <title>BarCode Scanner</title>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
 <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
 <script type="text/javascript" src="cordova.js"></script>
 <script type="text/javascript">
 
 var res = "";
 var familyid = "";
 var url ="http://10.136.34.148:8042";
 var flashStep = 1;

 function scan(str){
    cordova.plugins.barcodeScanner.scan(function(result){
        res = result;
        if(res.cancelled==0){
            if(str == "true"){
                addToServer(res,str);
            }
            if(str == "false"){
                removeFromServer(res,str);
            }
            flashFunction();
            scan(str);
        }
        
    },function(error){
        
        scan(str);
    });
 }

 function flashGreen() {
     if(flashStep==1) {
        document.bgColor="green";
        flashStep=2; 
     }
     else {
        document.bgColor="FFFFFF";
        flashStep=1;
     }
}


 function flashFunction() {
    var task = window.setInterval(flashGreen,100);
    setTimeout(function(){
        clearInterval(task);
        //scan(str);
    },5000);

}

function red(str) {
    $("#red").show();
    setTimeout(function(){
        $("#red").hide();
        scan(str);
    },1000);
}

function generateData(res,str) {
    var result = res;
    data = {
        itemList: [
          {
              barcode: result.text
          }
        ]
    }
    return data;
}


function addToServer(res,str){
    var data = generateData(res,str);
    $.ajax({
         type: "POST",
         url: url + "/family/" + familyid + "/addToFridge",
         data: data,
         crossDomain: true,
         dataType: "json",
         success: function (result) {
         },
         error: function(xhr,status,error){
         },
         dataType: "json"
     });
}

function removeFromServer(res,str){
    var data = generateData(res,str);
    $.ajax({
         type: "POST",
         url: url + "/family/" + familyid + "/addToGarbage",
         data: data,
         crossDomain: true,
         dataType: "json",
         success: function (result) {
         },
         error: function(xhr,status,error){
         },
         dataType: "json"
     });
}


function signInToServer(name){
         name = '{"familyname" : "myFamily1"}';
         $.ajax({
         type: "POST",
         url: url + "/login",
         data: JSON.stringify(name),
         crossDomain: false,
         contentType: "json",
         success: function (result) {
             familyid = result[0]._id; 
         },
         error: function(xhr,status,error){
             console.log(error);
         },
         dataType: "json"
     });
}


 </script>
</head>
<body onload="signInToServer('myFamily')">
<div id ="main" style= "display:show">
 <h3>Aries Scanner</h3>

 <button onclick="scan('true')">ADD </button>
  <button onclick="scan('false')">REMOVE </button>
</div>
<div id = "white" style="min-height:100%; min-width:100%; background-color:green; display:none; width:100%;height:100%; content:'' ; position:absolute">
</div>
<div id = "red" style="min-height:100%; min-width:100px; background-color:red; display:none; width:100%;height:100%; content:'' ;position:absolute">
</div> 
</body>
</html>