<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <title>BarCode Scanner</title>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
 <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
 <script type="text/javascript" src="cordova.js"></script>
 <script type="text/javascript">
 
 var res = "";
 var familyid = "";
 var url ="http://10.136.34.148:8042";
 
 function scan(str){
    cordova.plugins.barcodeScanner.scan(function(result){
        res = result;
        if(str == "true"){
            addToServer(res,str);
        }
        if(str == "false"){
            removeFromServer(res,str);
        }
        scan(str);
    },function(error){
        alert("error scanning barcode..Please try again");
        scan(str);
    });
 }

 function green(str) {
    $("#green").show();
    setTimeout(function(){
        $("#green").hide();
        scan(str);
    },1000);

}

function red(str) {
    $("#red").show();
    setTimeout(function(){
        $("#red").hide();
        scan(str);
    },1000);
}

function addToServer(res,str){
    var data = generateData(res,str);
    alert(JSON.stringify(data));
         $.ajax({
         type: "POST",
         url: url + "/family/" + familyid + "/addToFridge",
         data: JSON.stringify(data),
         crossDomain: true,
         contentType: "json",
         success: function (result) {
         },
         error: function(xhr,status,error){
         },
         dataType: "json"
     });
}

function removeFromServer(res,str){
    var data = generateData(res,str);
         $.ajax({
         type: "POST",
         url: url + "/family/" + familyid + "/addToGarbage",
         data: JSON.stringify(data),
         crossDomain: true,
         contentType: "json",
         success: function (result) {
         },
         error: function(xhr,status,error){
         },
         dataType: "json"
     });
}


function signInToServer(name){
         name = '{"familyname" : "myFamily1"}';
         $.ajax({
         type: "POST",
         url: url + "/login",
         data: JSON.stringify(name),
         crossDomain: false,
         contentType: "json",
         success: function (result) {
             familyid = result[0]._id; 
         },
         error: function(xhr,status,error){
             console.log(error);
         },
         dataType: "json"
     });
}

function generateData(res,str) {
    var result = res;
    alert(JSON.stringify(result));
     data = {
        "itemList": [
          {
              "barcode": result.text
          }
        ]
    }
}

 </script>
</head>
<body onload="signInToServer('myFamily')">
<div id ="main" style= "display:show">
 <h3>Aries Scanner</h3>

 <button onclick="scan('true')">ADD </button>
  <button onclick="scan('false')">REMOVE </button>
</div>
<div id = "green" style="min-height:100%; min-width:100%; background-color:green; display:none; width:100%;height:100%; content:'' ; position:absolute">
</div>
<div id = "red" style="min-height:100px; min-width:100px; background-color:red; display:none; width:100%;height:100%; content:'' ;position:absolute">
</div> 
</body>
</html>